/* FORMATIVA 3
LILIAN ZAPATA
CONSULTA BASE DE DATOS
3-5-2025
*/

SHOW USER;
-- CREACION DE LOS USUARIOS

CREATE USER PRY2205_USER1           -- CREACION DE USUARIO 1
    IDENTIFIED BY Oraclecloud123
    DEFAULT TABLESPACE DATA
    TEMPORARY TABLESPACE TEMP
    QUOTA 100M ON DATA;
    
CREATE USER PRY2205_USER2           -- CREACION DE USUARIO 2
    IDENTIFIED BY Oraclecloud123
    DEFAULT TABLESPACE DATA
    TEMPORARY TABLESPACE TEMP
    QUOTA 100M ON DATA;

--borrar los usuarios
-- DROP USER PRY2205_USER1 CASCADE;
-- DROP USER PRY2205_USER2 CASCADE;


-------------------------------------------------------
-- CREACION DE LOS ROLES
CREATE ROLE PRY2205_ROL_D;   -- rol para usuario 1
CREATE ROLE PRY2205_ROL_P;   -- rol para usuario 2

--borrar los roles
-- DROP ROLE PRY2205_ROL_D;
-- DROP ROLE PRY2205_ROL_P;
--------------------------------------------------------
-- ASIGNACION DE LOS ROLES
GRANT PRY2205_ROL_D TO PRY2205_USER1;  -- rol asignado
GRANT PRY2205_ROL_P TO PRY2205_USER2;  -- rol asignado

-------------------------------------------------------
-- ASIGNACION DE PRIVILEGIOS DE SESSION
GRANT CREATE SESSION TO PRY2205_ROL_D; 
GRANT CREATE SESSION TO PRY2205_ROL_P;

-------------------------------------------------------
-- CREACION DE LOS PRIVILEGIOS
GRANT CREATE TABLE TO PRY2205_ROL_D;            -- permite crear tablas a rolD
GRANT CREATE VIEW TO PRY2205_ROL_D;             -- permite crear vista a rolD
GRANT CREATE SYNONYM TO PRY2205_ROL_D;          -- permite crear sinonimo a rolD
GRANT CREATE PUBLIC SYNONYM TO PRY2205_ROL_D;   -- permite crear sinonimos publicos a rolD
GRANT CREATE INDEXTYPE TO PRY2205_ROL_D;        -- permite crear indexs a rolD
GRANT CREATE SEQUENCE TO PRY2205_USER1;         -- permite crear secuencia a USER1
GRANT CREATE PROCEDURE TO PRY2205_ROL_P;        -- permite crear predecimiento a rolP
GRANT CREATE TRIGGER TO PRY2205_ROL_P;          -- permite crear trigger a rolP


--GRANT DROP PUBLIC SYNONYM TO PRY2205_USER1;  --permite borrar los sinonimos por USER1

--------------------------------------------------------------------------------------------------
PRY2205_USER1

SHOW USER;


-- CREACION DE LOS SINONIMOS PUBLICOS PARA EL CASO 1
CREATE PUBLIC SYNONYM SYN_ALUMNO FOR PRY2205_USER1.ALUMNO;
CREATE PUBLIC SYNONYM SYN_CARRERA FOR PRY2205_USER1.CARRERA;
CREATE PUBLIC SYNONYM SYN_PRESTAMO FOR PRY2205_USER1.PRESTAMO;
CREATE PUBLIC SYNONYM SYN_DETALLE_PRESTAMO_MENSUAL FOR PRY2205_USER1.DETALLE_PRESTAMO_MENSUAL;
CREATE PUBLIC SYNONYM SYN_LIBRO FOR PRY2205_USER1.LIBRO;
CREATE PUBLIC SYNONYM SYN_EJEMPLAR FOR PRY2205_USER1.EJEMPLAR;
CREATE PUBLIC SYNONYM SYN_AUTOR FOR PRY2205_USER1.AUTOR;
CREATE PUBLIC SYNONYM SYN_EDITORIAL FOR PRY2205_USER1.EDITORIAL;
CREATE PUBLIC SYNONYM SYN_REBAJA_MULTA FOR PRY2205_USER1.REBAJA_MULTA;
CREATE PUBLIC SYNONYM SYN_VALOR_MULTA_PRESTAMO FOR PRY2205_USER1.VALOR_MULTA_PRESTAMO;
CREATE PUBLIC SYNONYM SYN_SEQ_DET_PRESTAMO_MENSUAL FOR PRY2205_USER1.SEQ_DET_PRESTAMO_MENSUAL;


/*DROP PUBLIC SYNONYM SYN_ALUMNO;      -- para borrar los sinonimos
DROP PUBLIC SYNONYM SYN_CARRERA;
DROP PUBLIC SYNONYM SYN_PRESTAMO;
DROP PUBLIC SYNONYM SYN_DETALLE_PRESTAMO_MENSUAL;
DROP PUBLIC SYNONYM SYN_LIBRO;
DROP PUBLIC SYNONYM SYN_EJEMPLAR;
DROP PUBLIC SYNONYM SYN_AUTOR;
DROP PUBLIC SYNONYM SYN_EDITORIAL;
DROP PUBLIC SYNONYM SYN_REBAJA_MULTA;
DROP PUBLIC SYNONYM SYN_VALOR_MULTA_PRESTAMO;
DROP PUBLIC SYNONYM SYN_SEQ_DET_PRESTAMO_MENSUAL;
*/
-- PERMITIR LA LECTURA DE LAS TABLAS PARA EL ROL P
GRANT SELECT ON PRY2205_USER1.ALUMNO TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.CARRERA TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.PRESTAMO TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.DETALLE_PRESTAMO_MENSUAL TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.LIBRO TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.EJEMPLAR TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.AUTOR TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.EDITORIAL TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.REBAJA_MULTA TO PRY2205_ROL_P;
GRANT SELECT ON PRY2205_USER1.VALOR_MULTA_PRESTAMO TO PRY2205_ROL_P;
GRANT INSERT ON PRY2205_USER1.DETALLE_PRESTAMO_MENSUAL TO PRY2205_USER2;

-- CREAR SECUENCIA
CREATE SEQUENCE SEQ_DET_PRESTAMO_MENSUAL 
    START WITH 1            -- comienza en 1
    INCREMENT BY 1          -- incrementa en 1
    NOCACHE                 -- no se gurada cache
    NOCYCLE;                -- no es ciclica
-- DROP SEQUENCE SEQ_DET_PRESTAMO_MENSUAL;   -- borrar secuencia

-- PERMISO PARA EL USO DE LA SECUENCIA PARA EL USUARIO 2
GRANT SELECT ON PRY2205_USER1.SEQ_DET_PRESTAMO_MENSUAL TO PRY2205_USER2;

-----------------------------------------------------------------------------------------

-- CASO 2

-- CREACION SINONIMOS PRIVADOS
CREATE SYNONYM SYN_ALUMNO FOR PRY2205_USER1.ALUMNO;
CREATE SYNONYM SYN_CARRERA FOR PRY2205_USER1.CARRERA;
CREATE SYNONYM SYN_PRESTAMO FOR PRY2205_USER1.PRESTAMO;

-- CREACION O REEMPLAZO PARA LA VISTA VW_RESUMEN_PRESTAMO_MENSUAL
CREATE OR REPLACE VIEW VW_RESUMEN_PRESTAMO_MENSUAL AS
SELECT
  TO_CHAR(SYSDATE, 'MM/YYYY') AS "FECHA_PROCESO",    -- formato de la fecha
  c.DESCRIPCION AS "CARRERA",                           -- nombre de la carrera
  COUNT(DISTINCT a.ALUMNOID) AS "TOTAL_ALUMNOS_CARRERA", -- conteo de los alumnos
  COUNT(DISTINCT p.ALUMNOID) AS "TOTAL_ALUMNOS_SOLIC_LIBRO", -- conteo de los alumnos que pidieron libr0
  COUNT(CASE WHEN p.FECHA_ENTREGA <= p.FECHA_TERMINO THEN 1 END) AS "TOTAL_DEVOL_EN_PLAZO",  -- conteo de cuanto lo devolvieron a tiempo
  COUNT(CASE WHEN p.FECHA_ENTREGA > p.FECHA_TERMINO THEN 1 END) AS "TOTAL_DEVOL_FUERA_PLAZO", -- conteo de atrasados por entregar
  SUM(NVL(vm.VALOR_MULTA, 0) * (1 - NVL(rm.PORC_REBAJA_MULTA, 0) / 100)) AS "VALOR_TOTAL_MULTA" -- calculo de la multa por atraso
FROM
  SYN_ALUMNO a  -- syn de tabla alumno
  JOIN SYN_CARRERA c ON a.CARRERAID = c.CARRERAID -- union sinonimo carrera mediante el id
  LEFT JOIN SYN_PRESTAMO p ON a.ALUMNOID = p.ALUMNOID -- union de sys prestamo, mediante id alumno
    AND p.FECHA_ENTREGA >= TRUNC(ADD_MONTHS(SYSDATE, -12), 'MM') -- rango de fechas
    AND p.FECHA_ENTREGA < TRUNC(ADD_MONTHS(SYSDATE, -11), 'MM')
  LEFT JOIN SYN_VALOR_MULTA_PRESTAMO vm ON
    GREATEST(0, p.FECHA_ENTREGA - p.FECHA_TERMINO) BETWEEN vm.CANT_DIAS_INI AND vm.CANT_DIAS_TER --greatest para que no de negativo
  LEFT JOIN SYN_REBAJA_MULTA rm ON c.CARRERAID = rm.CARRERAID  -- syn rebaja mediande carrera id
GROUP BY c.CARRERAID, c.DESCRIPCION
ORDER BY c.DESCRIPCION;  --ordear por descripcion

--PERMISO PARA USER2 PARA CONSULTAR LA VUSTA
GRANT SELECT ON VW_RESUMEN_PRESTAMO_MENSUAL TO PRY2205_USER2;

-- CREACION DEL SINONIMO PUBLICO PARA LA VISTA
CREATE PUBLIC SYNONYM SYN_RESUMEN_PRESTAMO FOR VW_RESUMEN_PRESTAMO_MENSUAL;


----------------------------------------------------------------------------------------------------
--caso 4
--creacion de sinonimos

 -- DROP INDEX IDX_FECHA_PROCESO_DATE; 

-- ALTER PARA AGREGAR UNA COLUMNA DE TIPO DATE 
ALTER TABLE DETALLE_PRESTAMO_MENSUAL
ADD FECHA_PROCESO_DATE DATE;

--CONVERTIR LOS VALORES DE MES/AÑO A DD-MM-AAAA
UPDATE DETALLE_PRESTAMO_MENSUAL
SET FECHA_PROCESO_DATE = TO_DATE(FECHA_PROCESO, 'MM/YYYY')
WHERE REGEXP_LIKE(FECHA_PROCESO, '^\d{2}/\d{4}$');

COMMIT; --CONFIRMA LOS CAMBIOS

-- CREACION DEL INDEX PARA FILTRAR FECHA_PROCESO_DATE
CREATE INDEX IDX_FECHA_PROCESO_DATE
ON DETALLE_PRESTAMO_MENSUAL(FECHA_PROCESO_DATE);

-- SELECT PARA VER DONDE APARECE FULL CON LOS FORMATOS DE FECHA
SELECT *
FROM DETALLE_PRESTAMO_MENSUAL
WHERE FECHA_PROCESO_DATE >= TO_DATE('2025-05-01', 'YYYY-MM-DD')
  AND FECHA_PROCESO_DATE < TO_DATE('2025-06-01', 'YYYY-MM-DD');

-------------------- resumen
--se usa la vista de user 2
CREATE INDEX IDX_PRESTAMO_FECHA_ENTREGA ON PRESTAMO(FECHA_ENTREGA);
CREATE INDEX IDX_PRESTAMO_ALUMNO ON PRESTAMO(ALUMNOID);
CREATE INDEX IDX_ALUMNO_CARRERA ON ALUMNO(CARRERAID);

---------------------------------------------------------------------------------
PRY2205_USER2

SHOW USER;

-- INSERT PARA GUARDAR LA INFROMACION EN EL SYS DE DETALLE_PRESTAMO_MENSUAL MEDIANTE SINONIMOS
INSERT INTO SYN_DETALLE_PRESTAMO_MENSUAL (
  CORRELATIVO, 
  FECHA_PROCESO, 
  PRESTAMOID, 
  LIBRO, 
  EJEMPLARID,
  ALUMNO, 
  CARRERA, 
  DIAS_ATRASO_DEVOLUCION, 
  VALOR_MULTA
)
SELECT
  PRY2205_USER1.SEQ_DET_PRESTAMO_MENSUAL.NEXTVAL,              -- Número correlativo desde secuencia
  TO_CHAR(SYSDATE, 'MM/YYYY'),                                 -- Fecha del proceso en formato mes/año
  p.PRESTAMOID,                                                -- ID del préstamo
  l.NOMBRE_LIBRO,                                              -- Nombre del libro
  e.EJEMPLARID,                                                -- Ejemplar del libro
  INITCAP(a.NOMBRE || ' ' || a.APATERNO || ' ' || a.AMATERNO), -- Nombre completo del alumno con formato
  INITCAP(c.DESCRIPCION),                                      -- Carrera formateada
  GREATEST(0, p.FECHA_ENTREGA - p.FECHA_TERMINO),              -- Días de atraso
  NVL(vm.VALOR_MULTA, 0) * (1 - NVL(rm.PORC_REBAJA_MULTA, 0)/100) -- Multa con descuento si aplica
FROM
  SYN_PRESTAMO p                                                    -- sinonimos de la tabla prestamos, alias p
  JOIN SYN_ALUMNO a ON p.ALUMNOID = a.ALUMNOID                      -- union de prestamo con el alumno que lo pide
  JOIN SYN_CARRERA c ON a.CARRERAID = c.CARRERAID                   --  une el alumno con la carrera
  JOIN SYN_EJEMPLAR e ON p.EJEMPLARID = e.EJEMPLARID AND p.LIBROID = e.LIBROID -- une el ejemplar especifico con el libro prestado
  JOIN SYN_LIBRO l ON e.LIBROID = l.LIBROID                                      -- une el titilo  con el id del ejemplar
  JOIN SYN_AUTOR au ON l.LIBROID = au.LIBROID                                    -- une libro id con el autor
  JOIN SYN_EDITORIAL ed ON l.EDITORIALID = ed.EDITORIALID                        --unce editorial con el id de editorial
  LEFT JOIN SYN_VALOR_MULTA_PRESTAMO vm                                         -- se usa left join para calcular los dias de atraso
    ON GREATEST(0, p.FECHA_ENTREGA - p.FECHA_TERMINO) BETWEEN vm.CANT_DIAS_INI AND vm.CANT_DIAS_TER -- greatest para que no haya negativos
  LEFT JOIN SYN_REBAJA_MULTA rm                                                  -- se une tabla carrera rebaja multa por id carrera
    ON c.CARRERAID = rm.CARRERAID
WHERE
  TO_CHAR(p.FECHA_ENTREGA, 'YYYY-MM') = TO_CHAR(ADD_MONTHS(SYSDATE, -12), 'YYYY-MM'); -- formato de la fecha de fecha actual menos 1 año
  
COMMIT;

-- SELECT PARA PODER VER LA CONSULTA
SELECT *                                            -- se consulta de la tabla SYN_DETALLE_PRESTAMO_MENSUAL
FROM SYN_DETALLE_PRESTAMO_MENSUAL
WHERE FECHA_PROCESO = TO_CHAR(SYSDATE, 'MM/YYYY')  -- se ve fecha actual con formato
ORDER BY CORRELATIVO;                              -- orden ASC del correlativo

-------------------------------------------------------------
--CASO 2

SELECT * FROM SYN_RESUMEN_PRESTAMO; -- select de la tabla SYN_RESUMEN_PRESTAMO mediando sinonimo
